{
  "id": "finops_analyst_6261a4_tool_5_blended_cost_by_tier",
  "tags": [
    "analytics",
    "chargeback",
    "weighted-cost"
  ],
  "type": "esql",
  "description": "Calculate weighted blended costs by tier using storage, query, and indexing weights",
  "configuration": {
    "query": "FROM billing_cluster_cost_lookup\n| LOOKUP JOIN chargeback_conf_lookup ON @timestamp >= conf_start_date AND @timestamp <= conf_end_date\n| LOOKUP JOIN cluster_deployment_contribution_lookup ON composite_key\n| LOOKUP JOIN cluster_tier_contribution_lookup ON composite_key\n| EVAL indexing = CASE(deployment_sum_indexing_time > 0, TO_DOUBLE(tier_sum_indexing_time) / deployment_sum_indexing_time * total_ecu, 0),\n        querying = CASE(deployment_sum_query_time > 0, TO_DOUBLE(tier_sum_query_time) / deployment_sum_query_time * total_ecu, 0),\n        data_set = CASE(deployment_sum_data_set_store_size > 0, TO_DOUBLE(tier_sum_data_set_store_size) / deployment_sum_data_set_store_size * total_ecu, 0),\n        store = CASE(deployment_sum_store_size > 0, TO_DOUBLE(tier_sum_store_size) / deployment_sum_store_size * total_ecu, 0)\n| EVAL storage = CASE(store == 0, data_set, store)\n| EVAL total_weight_hot = conf_storage_weight + conf_query_weight + conf_indexing_weight,\n        total_weight_cold = conf_storage_weight + conf_query_weight\n| EVAL blended = CASE(tier == \"hot/content\", ((storage * conf_storage_weight) + (querying * conf_query_weight) + (indexing * conf_indexing_weight)) / total_weight_hot, ((storage * conf_storage_weight) + (querying * conf_query_weight)) / total_weight_cold) * conf_ecu_rate,\n        deployment = CONCAT(deployment_name, \" (\", LEFT(deployment_id, 6), \")\")\n| STATS agg_blended = SUM(blended) BY deployment, tier\n| WHERE agg_blended > 0\n| SORT agg_blended DESC\n| LIMIT 50\n",
    "params": {}
  }
}